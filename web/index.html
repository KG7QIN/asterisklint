<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <!--<link rel="icon" href="../../favicon.ico">-->

    <title>Asterisklint Example</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <!--<link href="starter-template.css" rel="stylesheet">-->
    <style>
      /* Sticky footer styles
      -------------------------------------------------- */
      html {
        position: relative;
        min-height: 100%;
      }
      body {
        /* Margin bottom by footer height */
        margin-bottom: 60px;
      }
      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        /* Set the fixed height of the footer here */
        height: 60px;
        line-height: 60px; /* Vertically center the text there */
        background-color: #f5f5f5;
      }
      /* Custom styles
      -------------------------------------------------- */
      textarea {
        font-family: monospace;
      }
      .code {
        margin-bottom: 20px;
        font-family: monospace;
      }
      .ok {
        background-color: #efe;
      }
      .bad {
        background-color: #fee;
      }
      .bad ul, .bad li {
        font-size: 11px;
        margin: 0;
        padding: 0 0 0 12px;
      }
    </style>
  </head>

  <body>

    <nav class="navbar navbar-fixed-top navbar-dark bg-inverse">
      <a class="navbar-brand" href="#">Asterisklint Example</a>
      <!--
      <ul class="nav navbar-nav">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Contact</a>
        </li>
      </ul>
      -->
    </nav>

    <div class="container-fluid">

      <div class="starter-template">
        <h1>Asterisklint Example</h1>
        <p class="lead">Quickly check your Asterisk dialplan.</p>
      </div>

      <p>
        Paste your dialplan here and click on "Evaluate".
      </p>

      <div id="results"></div>

      <form>
        <div class="form-group">
          <textarea class="form-control" rows="10">
[default]
exten =&gt; _8[2-9]x,1,NoOp
 same =&gt; n,Set(CALLERID(name)=incoming)
 same =&gt; n,GoSub(somewhere,s,1(argument1,argument2)
 same =&gt; n,Payback(audiofile)

[acme-incoming]
exten =&gt; s,1,Wait(1)
exten =&gt; s,n,Answer()
exten =&gt; s,n(menu),Playback(acme/vm-brief-menu)
exten =&gt; s,n(exten),Background(vm-enter-num-to-call)
exten =&gt; s,n,WaitExten(5)
exten =&gt; s,n(goodbye),Playback(vm-goodbye)
exten =&gt; s,n(end),Hangup()
          </textarea>
        </div>
        <button type="submit" class="btn btn-primary">Evaluate</button>
      </form>

    </div><!-- /.container-fluid -->


    <footer class="footer">
      <div class="container">
        <span class="text-muted">OSSO B.V. 2016, Walter Doekes &mdash;
          <a href="https://github.com/ossobv/asterisklint">Asterisklint</a></span>
      </div>
    </footer>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js" integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js" integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="https://maxcdn.bootstrapcdn.com/js/ie10-viewport-bug-workaround.js" integrity="sha384-EZKKO3vHj6CHKQPIi5+Ubzvx7GjCAfgb/28vGjgly8qKb2DMq7V5D2o//Bjp9z03" crossorigin="anonymous"></script>

    <!-- Asterisklint -->
    <script>
      function getTextarea() {
        return $('textarea').val().replace(/\r/g, '').replace(/\s*$/, '\n');
      }
      function logInput(results) {
        var output = [];
        var input = getTextarea().replace(/\s+$/, '').split('\n');
        var problemPtr = 0;
        var divOpen = false;
        for (var lineno = 1; lineno <= input.length; ++lineno) {
          var line = input[lineno - 1];
          if (problemPtr < results.length && results[problemPtr].line == lineno) {
            if (divOpen) {
              output.push('</div>');
              divOpen = false;
            }
            output.push('<div class="bad">' + $('<div/>').text(line).html());
            output.push('<ul>');
            while (problemPtr < results.length && results[problemPtr].line == lineno) {
              output.push('<li>' + JSON.stringify(results[problemPtr]) + '</li>');
              ++problemPtr;
            }
            output.push('</ul></div>');
          } else {
            if (!divOpen) {
              output.push('<div class="ok">');
              divOpen = true;
            }
            output.push($('<div/>').text(line).html() + '<br/>');
          }
        }
        if (divOpen) {
          output.push('</div>');
          divOpen = false;
        }
        $('#results').append('<div class="code">' + output.join('') + '</div>');
      }
      function logJoy() {
        $('#results').html('<div class="alert alert-success" role="alert"><p>0 warnings/errors</p></div>');
      }
      function logSadness(results) {
        var lineZero = [];
        var count = results.length;
        while (results.length && results[0].line == 0) {
          lineZero.push(results[0]);
          results.splice(0, 1);
        }
        var html = '<div class="alert alert-warning" role="alert"><p>' + count + ' warnings/errors';
        for (var i = 0; i < lineZero.length; ++i) {
          html += '</p><p>' + JSON.stringify(lineZero[i]);
        }
        html += '</p></div>';
        $('#results').html(html);
      }
      function onSuccess(data) {
        var res = data['results']['extensions.conf'];
        if (res.length) {
          logSadness(res);
        } else {
          logJoy();
        }
        logInput(res);
      }
      $('form').on('submit', function() {
        data = JSON.stringify({'files': {'extensions.conf': getTextarea()}});
        jQuery.post('/dialplan-check/', data, onSuccess);
        return false;
      });
    </script>
  </body>
</html><!-- vim: set ts=8 sw=2 sts=2 et ai: -->
